---
title: "project2"
author: "Ze Li"
date: "2023-12-18"
output: pdf_document
---

## Libraries

```{r library, message = FALSE}
library(tidyverse)
library(readr)
library(boot)
library(table1)
library(gridExtra)
library(MASS)
library(car)
library(dplyr)
library(leaps)
library(corrplot)
library(survival)
```

## Data Clean

```{r data load}
breastcancer_data =
  read_csv("Project_2_data.csv") |>
  janitor::clean_names()
  
summary(breastcancer_data)
```

```{r data clean}
bc = breastcancer_data |>
  mutate(
    race = factor(race, levels = c("White", "Black", "Other")),
    marital_status = factor(marital_status, levels = c("Married", "Divorced", 
                                                       "Single", "Widowed", 
                                                       "Separated")),
    t_stage = factor(t_stage, levels = c("T1", "T2", "T3", "T4")),
    n_stage = factor(n_stage, levels = c("N1", "N2", "N3")),
    x6th_stage = factor(x6th_stage, levels = c("IIA", "IIIA", "IIIC", "IIB", "IIIB")),
    differentiate = factor(differentiate, levels = c("Poorly differentiated", 
                                                     "Moderately differentiated", 
                                                     "Well differentiated", 
                                                     "Undifferentiated")),
    grade = factor(grade, levels = c("1", "2", "3", "anaplastic; Grade IV")),
    a_stage = factor(a_stage, levels = c("Distant", "Regional")),
    estrogen_status = factor(estrogen_status, levels = c("Negative", "Positive")),
    progesterone_status = factor(progesterone_status, 
                                 levels = c("Negative", "Positive")),
    status = factor(status, levels = c("Dead", "Alive"))
  )
```

## Descriptive statistics for all variables

```{r Descriptive statistics}
summary(bc)
```

## Fit a Cox Proportional Hazards Model

```{r cox model}
bc$survival_months <- as.numeric(bc$survival_months)
bc$status <- as.numeric(bc$status)
surv_obj <- Surv(time = bc$survival_months, event = bc$status)

# Fit the Cox model
cox_model <- coxph(surv_obj ~ age + race + marital_status + t_stage + n_stage + x6th_stage + 
                     differentiate + grade + a_stage + tumor_size + estrogen_status + 
                     progesterone_status + regional_node_examined + reginol_node_positive, data = bc)
summary(cox_model)
```

### Check Proportional Hazards Assumption

```{r Schoenfeld residuals}
zph <- cox.zph(cox_model)
plot(zph)
```

A non-random pattern or a significant global test (p-value) can indicate violations of the assumption.

### Identify Influential Observations

```{r}
martingale_res <- residuals(cox_model, type = "martingale")
plot(martingale_res)
```

It seems there are few observations with large negative Martingale residuals, which could be potential outliers or influential observations. 